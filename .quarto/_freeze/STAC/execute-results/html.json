{
  "hash": "cab4c6396c37bb34f2a4c39cc1b3c508",
  "result": {
    "markdown": "---\nexecute:\n  eval: false\n---\n\n# Spatio-Temporal Asset Catalogs\n\nThere is currently no good way of making and editing STAC Metadata in R, so this will be a Python-centric tutorial for the time being. The RSTAC Package offers the ability to search and use STAC APIs and should work with static catalogs (such as being built in the below tutorial), in the near future. In the meantime, [pystac](https://pystac.readthedocs.io/en/latest/index.html) offers a fairly simple way of searching, developing, and editing STAC Metadata.\n\n## Building STAC metadata with PySTAC\nLoad the required packages\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport pystac\nimport datetime as dt\nimport shapely\n#Other useful packages that help automate parts of this process:\n# import riostac #this is a useful package \n# import xarray stac\n```\n:::\n\n\n### STAC catalogs \n\nCatalogs are the simplest of the possible STAC specifications to make as it does not have to have any specific spatio-temporal extent to describe them. The example below shows how to build a very basic STAC catalog using pystac. \n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nproductivity_catalog = pystac.Catalog( \n  id=\"crop_productivity_data\",\n  description=\"Modelled data of crop productivity\",\n  title=\"Crop Productivity\"\n  )\n```\n:::\n\n\n### STAC collections\nSTAC collections are very similar to STAC catalogs, except they have extra metadata such as a spatio-temporal extent, keywords, custom fields, and STAC extensions which are explained in more detail in the STAC extension heading. They are a bit more difficult to build due to this extra metadata, but the general process is below. \n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\n# Build the temporal extent of the collection\n# the strptime function takes a string time and the format it is in such as %Y-%M-%d\n# STAC requires the time to be in UTC, so the replace function forces it into that format\n# NOTE: that this method will default to YEAR-01-01 if the month and day aren't provided/NA\ntime = ['2000', '2030']\nstart = str(dt.datetime.strptime(time[0], '%Y').replace(tzinfo=datetime.timezone.utc))\nend = str(dt.datetime.strptime(time[1], '%Y').replace(tzinfo=datetime.timezone.utc))\n\n# Build the spatial extent of the collection\n# The bounds can be calculated using the riostac package, rasterio, terra, etc. \nbounds = {'xmin': -180, 'ymin': -90, 'xmax': 180, 'ymax': 90}\nbbox = [bounds['xmin'], bounds['ymin'], bounds['xmax'], bounds['ymax']]\n\n# And now put the whole catalog together\nproductivity_paper_collection = pystac.Collection(id = \"paper1_data\",\n    description = \"data from paper by Todd\",\n    keywords = \"productivity\", \"maize\", \"rice\", \"treated\", \"adaptation\"\n    license = \"CC-BY-4.0\",\n    extent = pystac.Extent(\n        spatial = pystac.SpatialExtent(bboxes=[bbox]),\n        temporal = pystac.TemporalExtent(\n            intervals=[\n            start,\n            end\n            ]\n        )\n    )\n)\n```\n:::\n\n\n### STAC items\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\n# In this example the bbox of the item is the same as the collection,\n# but this is not always the case\nbounds = {'xmin': -180, 'ymin': -90, 'xmax': 180, 'ymax': 90}\nbbox = [bounds['xmin'], bounds['ymin'], bounds['xmax'], bounds['ymax']]\nfootprint = shapely.Polygon([\n            [bounds['xmin'], bounds['ymin']],\n            [bounds['xmin'], bounds['ymax']],\n            [bounds['xmax'], bounds['ymax']],\n            [bounds['xmax'], bounds['ymin']]\n        ])\n\n# Now we set the date of the item\n# we could use 'strptime()' agin if date is a charachter, or set it like this:\ndata_date = dt.datetime(2020, 2, 5).replace(tzinfo=dt.timezone.utc)\n\nitem = pystac.Item(id='maize_productivity.tif',\n                      geometry=footprint,\n                      bbox=bbox,\n                      datetime=data_date, #Can be set to `None` if multiple dates\n                      #start_datetime=start_date, #Optional if multiple dates\n                      #end_datetime=end_date, \n                      properties={\n                          'extraMetadataField': 'value',\n                          'extraMetadataField2': 'value2',\n                          \"unit\": \"kg/ha\",\n                          \"ssp\": \"SSP2-4.5\"\n                      })\n```\n:::\n\n\nMost often there will be more than one item in a collection. It is often useful to wrap the above code into a for loop and append each item to a list of items.\n### STAC assets\nThis is the final piece of the STAC spec. An asset holds the paths to the STAC Item, other data, derived datasets, and other useful assets. It offers a lot of flexibility, you can have a single asset for each date, a different asset for each model or crop, etc. depending on what fits best with the data.\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\nasset = pystac.Asset(href=\"s3://bucket/maize_productivity.tif\", \n                     media_type=pystac.MediaType.COG)\nitem.add_asset(\"COG Image\", asset)\n\n# or for multiple\ns3_uris = [\n    \"s3://bucket/maize_productivity_2020-1.tif\",\n    \"s3://bucket/maize_productivity_2020-2.tif\",\n    \"s3://bucket/maize_productivity_2020-3.tif\"\n    ]\n\nfor uri in s3_uris:\n    asset = pystac.Asset(href=uri, media_type=pystac.MediaType.COG)\n    asset_time = uri.split(\"_\")[-1] # get the filename \n    asset_name = f'maize productivity cog {asset_time}'\n    item.add_asset(asset_name, asset)\n```\n:::\n\n\n### STAC extensions\nSTAC extensions can be added to all of the STAC specifications - catalogs, collections, items, and assets. These extensions provide a more formal metadata framework for certain types/aspects of metadata (i.e. raster, projection, or data cube specific metadata).\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\nproj = pystac.extensions.ProjectionExtension.ext(item, add_if_missing=True) #add to the item\n\nproj.apply(epsg=4326)\n```\n:::\n\n\n### Combining them all into a final catalog\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\n# add the item to the collection\nproductivity_paper_collection.add_item(item)\n# use .add_items() if you have multiple items in a list \n\n# Add the collection to the catalog\nproductivity_catalog.add_child(productivity_paper_collection)\n\n# Now just save it\nproductivity_catalog.normalize_and_save(\"~/stac/\", catalog_type=pystac.CatalogType.SELF_CONTAINED)\n```\n:::\n\n\n## Update an existing catalog\n\n",
    "supporting": [
      "STAC_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}